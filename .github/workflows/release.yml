name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "SemVer without leading v (example: 0.2.0 or 0.2.0-rc.1)"
        required: true
        type: string
      ref:
        description: "Git ref to release from (branch, tag, or SHA)"
        required: false
        default: "main"
        type: string

permissions:
  contents: write

concurrency:
  group: release-${{ github.event_name }}-${{ github.ref_name || github.run_id }}
  cancel-in-progress: false

jobs:
  prepare-tag:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.meta.outputs.tag_name }}
      version: ${{ steps.meta.outputs.version }}
    steps:
      - name: Checkout ref
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref }}

      - name: Prepare metadata
        id: meta
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag_name=v${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Validate SemVer input
        env:
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          set -euo pipefail
          if ! [[ "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$ ]]; then
            echo "Input version '${VERSION}' is not valid SemVer."
            exit 1
          fi

      - name: Validate workspace version matches input
        env:
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          set -euo pipefail
          workspace_version="$(awk '
            /^\[workspace\.package\]/ { in_section = 1; next }
            in_section && /^\[/ { in_section = 0 }
            in_section && /^version[[:space:]]*=/ {
              gsub(/"/, "", $3);
              print $3;
              exit
            }
          ' Cargo.toml)"

          if [[ -z "${workspace_version}" ]]; then
            echo "Could not read [workspace.package].version from Cargo.toml"
            exit 1
          fi

          if [[ "${workspace_version}" != "${VERSION}" ]]; then
            echo "Version mismatch:"
            echo "  Cargo.toml [workspace.package].version = ${workspace_version}"
            echo "  workflow input version             = ${VERSION}"
            echo "Update Cargo.toml via PR before releasing."
            exit 1
          fi

      - name: Ensure tag does not already exist
        env:
          TAG_NAME: ${{ steps.meta.outputs.tag_name }}
        run: |
          set -euo pipefail
          if git rev-parse --quiet --verify "refs/tags/${TAG_NAME}" >/dev/null; then
            echo "Tag ${TAG_NAME} already exists locally."
            exit 1
          fi

          if git ls-remote --exit-code --tags origin "refs/tags/${TAG_NAME}" >/dev/null; then
            echo "Tag ${TAG_NAME} already exists on origin."
            exit 1
          fi

      - name: Create and push release tag
        env:
          TAG_NAME: ${{ steps.meta.outputs.tag_name }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "${TAG_NAME}" -m "Release ${TAG_NAME}"
          git push origin "${TAG_NAME}"

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [prepare-tag]
    if: ${{ always() && (github.event_name == 'push' || needs.prepare-tag.result == 'success') }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest]
    env:
      TAG_NAME: ${{ github.event_name == 'push' && github.ref_name || needs.prepare-tag.outputs.tag_name }}
    steps:
      - name: Checkout release ref
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'push' && github.ref || needs.prepare-tag.outputs.tag_name }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --locked --release -p simple-term-app

      - name: Package binary (macOS)
        id: package_macos
        run: |
          set -euo pipefail
          mkdir -p dist
          os="$(echo "${RUNNER_OS}" | tr '[:upper:]' '[:lower:]')"
          arch="$(echo "${RUNNER_ARCH}" | tr '[:upper:]' '[:lower:]')"
          artifact="simple-term-${TAG_NAME}-${os}-${arch}.tar.gz"
          tar -C target/release -czf "dist/${artifact}" simple-term
          echo "artifact_path=dist/${artifact}" >> "$GITHUB_OUTPUT"

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-asset-${{ runner.os }}
          path: dist/*
          if-no-files-found: error

  publish:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [build, prepare-tag]
    if: ${{ always() && needs.build.result == 'success' && (github.event_name == 'push' || needs.prepare-tag.result == 'success') }}
    env:
      TAG_NAME: ${{ github.event_name == 'push' && github.ref_name || needs.prepare-tag.outputs.tag_name }}
    steps:
      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-asset-*
          merge-multiple: true
          path: dist

      - name: Generate checksums
        run: |
          set -euo pipefail
          cd dist
          sha256sum * > SHA256SUMS.txt

      - name: Create or update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: simple-term ${{ env.TAG_NAME }}
          prerelease: ${{ contains(env.TAG_NAME, '-') }}
          generate_release_notes: true
          files: dist/*
